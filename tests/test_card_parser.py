import pytest
from bs4 import BeautifulSoup
from src.parser import Parser, parse_accommodation_card, parse_accommodations_summaries
from src.models import Accommodation
from typing import Dict

# Ground truth dictionary
# Keys are HTML strings of accommodation cards
# Values are expected Accommodation objects
ground_truth: Dict[str, Accommodation] = {
    """<li class="fr-col-12 fr-col-sm-6 fr-col-md-4 svelte-11sc5my fr-col-lg-4"><div class="fr-card svelte-12dfls6"><div class="fr-card__header"><div class="fr-card__img pictures svelte-12dfls6"><img class="fr-responsive-img" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/27d4c545-fc8e-11e7-89ed-005056940822/5a620de1e0710-Le Velum_4.jpg" loading="lazy" data-fr-js-ratio="true"> <img class="fr-responsive-img inset-picture svelte-12dfls6" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/506/648ad69637f4f-IMG_20230614_153530_1.jpg" loading="lazy" data-fr-js-ratio="true"></div> <ul class="fr-badges-group"><li><p class="fr-badge">393,46 €</p></li> <li><button title="Ajouter à ma sélection" class="svelte-eq6rxe fr-badge"><span class="fr-icon-heart-line fr-icon--sm" aria-hidden="true"></span> </button> </li></ul></div> <div class="fr-card__body"><div class="fr-card__content"><h3 class="fr-card__title"><a href="/tools/36/accommodations/506">LE VELUM</a></h3> <p class="fr-card__desc">Avenue du Commandant CLERE 40000 MONT-DE-MARSAN</p>  <div class="fr-card__end"><p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M2 2h5v5H2V2zm0 15h5v5H2v-5zM17 2h5v5h-5V2zm0 15h5v5h-5v-5zM8 4h8v2H8V4zM4 8h2v8H4V8zm14 0h2v8h-2V8zM8 18h8v2H8v-2z"></path></svg> 19 m²</p> <p class="fr-card__detail fr-icon-group-fill">Individuel</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M22 11v9h-2v-3H4v3H2V4h2v10h8V7h6a4 4 0 0 1 4 4zM8 13a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path></svg> 1 lit simple</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0H24V24H0z"></path><path d="M20 12v10c0 .552-.448 1-1 1H5c-.552 0-1-.448-1-1V12h16zM9 14H7v5h2v-5zM19 1c.552 0 1 .448 1 1v8H4V2c0-.552.448-1 1-1h14zM9 4H7v4h2V4z"></path></svg> WC, Douche, Evier + plaque, Frigo</p> </div></div></div></div> </li>""": Accommodation(
        id=506,
        title="LE VELUM",
        image_url="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/27d4c545-fc8e-11e7-89ed-005056940822/5a620de1e0710-Le Velum_4.jpg",  # type: ignore
        price=393.46,
    ),
    """<li class="fr-col-12 fr-col-sm-6 fr-col-md-4 svelte-11sc5my fr-col-lg-4"><div class="fr-card svelte-12dfls6"><div class="fr-card__header"><div class="fr-card__img pictures svelte-12dfls6"><img class="fr-responsive-img" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/4febd47d-1227-11e8-89ed-005056940822/626fda8aecc19-DSCF6418.JPG" loading="lazy" data-fr-js-ratio="true"> <img class="fr-responsive-img inset-picture svelte-12dfls6" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/2477/626fefc48645a-CH 10 M² 2.jpg" loading="lazy" data-fr-js-ratio="true"></div> <ul class="fr-badges-group"><li><p class="fr-badge">197 €</p></li> <li><button title="Ajouter à ma sélection" class="svelte-eq6rxe fr-badge"><span class="fr-icon-heart-line fr-icon--sm" aria-hidden="true"></span> </button> </li></ul></div> <div class="fr-card__body"><div class="fr-card__content"><h3 class="fr-card__title"><a href="/tools/36/accommodations/2477">Residence Pierrette Grimaldi</a></h3> <p class="fr-card__desc">22 avenue Jean Nicoli, BP 55, 20250 CORTE</p>  <div class="fr-card__end"><p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M2 2h5v5H2V2zm0 15h5v5H2v-5zM17 2h5v5h-5V2zm0 15h5v5h-5v-5zM8 4h8v2H8V4zM4 8h2v8H4V8zm14 0h2v8h-2V8zM8 18h8v2H8v-2z"></path></svg> de 9,9 à 11,9 m²</p> <p class="fr-card__detail fr-icon-group-fill">Individuel</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M22 11v9h-2v-3H4v3H2V4h2v10h8V7h6a4 4 0 0 1 4 4zM8 13a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path></svg> 1 lit simple</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0H24V24H0z"></path><path d="M20 12v10c0 .552-.448 1-1 1H5c-.552 0-1-.448-1-1V12h16zM9 14H7v5h2v-5zM19 1c.552 0 1 .448 1 1v8H4V2c0-.552.448-1 1-1h14zM9 4H7v4h2V4z"></path></svg> WC, Douche, Frigo, Micro-onde</p> </div></div></div></div> </li>""": Accommodation(
        id=2477,
        title="Residence Pierrette Grimaldi",
        image_url="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/4febd47d-1227-11e8-89ed-005056940822/626fda8aecc19-DSCF6418.JPG",  # type: ignore
        price=197,
    ),
    """<li class="fr-col-12 fr-col-sm-6 fr-col-md-4 svelte-11sc5my fr-col-lg-4"><div class="fr-card svelte-12dfls6"><div class="fr-card__header"><div class="fr-card__img pictures svelte-12dfls6"><img class="fr-responsive-img" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/681cdf40-7875-11e9-a02d-005056941f86/5cde7c476384f-Sartre.jpg" loading="lazy" data-fr-js-ratio="true"> <img class="fr-responsive-img inset-picture svelte-12dfls6" alt="" src="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/1185/5cdeb82777ba0-SARTRE T1 bis-1.jpg" loading="lazy" data-fr-js-ratio="true"></div> <ul class="fr-badges-group"><li><p class="fr-badge">de 418,4 à 481,2 €</p></li> <li><button title="Ajouter à ma sélection" class="svelte-eq6rxe fr-badge"><span class="fr-icon-heart-line fr-icon--sm" aria-hidden="true"></span> </button> </li></ul></div> <div class="fr-card__body"><div class="fr-card__content"><h3 class="fr-card__title"><a href="/tools/36/accommodations/1185">Residence J.P. Sartre</a></h3> <p class="fr-card__desc">1, rue Gaston DEFERRE - 90000 BELFORT -</p>  <div class="fr-card__end"><p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M2 2h5v5H2V2zm0 15h5v5H2v-5zM17 2h5v5h-5V2zm0 15h5v5h-5v-5zM8 4h8v2H8V4zM4 8h2v8H4V8zm14 0h2v8h-2V8zM8 18h8v2H8v-2z"></path></svg> 35 m²</p> <p class="fr-card__detail fr-icon-group-fill">Individuel, Couple</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0h24v24H0z"></path><path d="M22 11v9h-2v-3H4v3H2V4h2v10h8V7h6a4 4 0 0 1 4 4zM8 13a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path></svg> 1 lit simple, 1 lit rapprochable</p> <p class="fr-card__detail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="icon svelte-14ftouv" fill="var(--text-mention-grey)"><path fill="none" d="M0 0H24V24H0z"></path><path d="M20 12v10c0 .552-.448 1-1 1H5c-.552 0-1-.448-1-1V12h16zM9 14H7v5h2v-5zM19 1c.552 0 1 .448 1 1v8H4V2c0-.552.448-1 1-1h14zM9 4H7v4h2V4z"></path></svg> WC, Douche, Evier + plaque, Frigo, Duplex, Balcon</p> </div></div></div></div> </li>""": Accommodation(
        id=1185,
        title="Residence J.P. Sartre",
        image_url="https://trouverunlogement.lescrous.fr/media/cache/resolve/preview/681cdf40-7875-11e9-a02d-005056941f86/5cde7c476384f-Sartre.jpg",  # type: ignore
        price="de 418,4 à 481,2 €",
    ),
}


@pytest.mark.parametrize("html,expected", ground_truth.items())
def test_parse_accommodation_card(html: str, expected: Accommodation):
    soup = BeautifulSoup(html, "html.parser")
    result = parse_accommodation_card(soup)

    assert result is not None

    assert result.id == expected.id
    assert result.title == expected.title
    assert result.image_url == expected.image_url
    assert result.price == expected.price
